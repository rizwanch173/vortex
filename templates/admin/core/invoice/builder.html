{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}{% if invoice_obj %}Edit Invoice {{ invoice_obj.invoice_number }}{% else %}Create Invoice{% endif %} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block content %}
<style>
    /* Compact modern styling scoped to this page */
    .invoice-shell {
        background: linear-gradient(120deg, #f7f9fc 0%, #f2f6ff 100%);
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 22px;
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.07);
    }
    .panel {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 16px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
    }
    .panel h2 {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
        margin-top: 0;
        margin-bottom: 12px;
        color: #0f172a;
    }
    .pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4338ca;
        font-size: 12px;
        font-weight: 600;
    }
    .field-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
    }
    .field-grid label {
        font-weight: 600;
        color: #0f172a;
    }
    .meta-text {
        color: #6b7280;
        font-size: 13px;
    }
    .items-card {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .item-adder-row {
        display: grid;
        grid-template-columns: minmax(260px, 1fr) 160px auto;
        gap: 12px;
        align-items: center;
    }
    .item-adder-row > div {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .item-adder-row .adder-label {
        visibility: hidden;
        height: 1em;
    }
    .item-adder-row .adder-button {
        height: 42px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }
    @media (max-width: 900px) {
        .item-adder-row {
            grid-template-columns: 1fr;
        }
        .item-adder-row .adder-button {
            width: 100%;
        }
    }
    .item-row {
        display: grid;
        grid-template-columns: 1.2fr 0.7fr 0.3fr;
        gap: 12px;
        align-items: center;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 12px 14px;
    }
    .item-row > div {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .item-row .item-action-label {
        visibility: hidden;
        height: 1em;
    }
    .item-row h4 {
        margin: 0 0 4px 0;
        font-size: 15px;
        color: #0f172a;
    }
    .item-row .subline {
        color: #6b7280;
        font-size: 13px;
    }
    .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: #ecfeff;
        color: #0ea5e9;
        font-weight: 600;
        font-size: 12px;
    }
    .totals-block {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 14px 16px;
        background: #0f172a;
        color: #e2e8f0;
    }
    .totals-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
    }
    .totals-row strong {
        color: #fff;
    }
    .primary-btn {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.08s ease, box-shadow 0.12s ease;
        box-shadow: 0 10px 30px rgba(37, 99, 235, 0.25);
    }
    .primary-btn:hover { transform: translateY(-1px); }
    .primary-btn:active { transform: translateY(0); }
    .invoice-shell .errorlist {
        margin: 0 0 20px;
        padding: 12px 14px;
        border-radius: 10px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #b91c1c;
        list-style: none;
    }
    .invoice-shell .errorlist li {
        margin: 0;
    }

    /* Dark theme alignment with Unfold */
    .dark .invoice-shell {
        background: linear-gradient(135deg, #0b1220 0%, #0f172a 100%);
        border-color: #1f2937;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.45);
    }
    .dark .panel {
        background: #0f172a;
        border-color: #1f2937;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }
    .dark .panel h2,
    .dark .field-grid label,
    .dark .item-row h4 {
        color: #e5e7eb;
    }
    .dark .meta-text,
    .dark .item-row .subline {
        color: #94a3b8;
    }
    .dark .pill {
        background: #1e293b;
        color: #93c5fd;
    }
    .dark .item-row {
        background: #0b1324;
        border-color: #1f2937;
    }
    .dark .invoice-shell .errorlist {
        background: rgba(239, 68, 68, 0.12);
        border-color: #7f1d1d;
        color: #fecaca;
    }
    .dark .item-adder {
        background: #0b1324 !important;
        border-color: #1f2937 !important;
    }
    .dark .badge {
        background: #0b2a3a;
        color: #38bdf8;
    }
    .dark .totals-block {
        background: #0b1324;
        border-color: #1f2937;
        color: #e5e7eb;
    }
    .dark .totals-row strong {
        color: #fff;
    }
    .dark .invoice-shell input:not([type="submit"]):not([type="button"]):not([type="reset"]):not([type="checkbox"]):not([type="radio"]),
    .dark .invoice-shell select,
    .dark .invoice-shell textarea {
        background: #0f172a !important;
        border-color: #1f2937 !important;
        color: #e5e7eb !important;
    }
    .dark .invoice-shell input::placeholder,
    .dark .invoice-shell textarea::placeholder {
        color: #94a3b8;
    }
</style>

<div id="content-main" class="module invoice-shell">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px;">
        <div>
            <h1 style="margin:0; font-size:22px;">{% if invoice_obj %}Edit Invoice {{ invoice_obj.invoice_number }}{% else %}Create Invoice{% endif %}</h1>
            <p class="meta-text" style="margin:4px 0 0 0;">Build an invoice by selecting visa applications and setting per-item discounts.</p>
        </div>
        <span class="pill">{% if invoice_obj %}Editing{% else %}New flow{% endif %}</span>
    </div>

    {% if errors %}
    <ul class="errorlist">
            {% for error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <form id="invoice_form" method="post" novalidate>
        {% csrf_token %}

        <fieldset class="module aligned panel">
            <h2>Client & Dates <span class="pill">Step 1</span></h2>
            <div class="field-grid">
                <div>
                    <label class="required" for="client-select">Client</label>
                    <select id="client-select" name="client" required style="width: 100%; min-width: 260px; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db;">
                        <option value="">-- Select a client --</option>
                        {% for client in clients %}
                            <option value="{{ client.pk }}" {% if client.pk|stringformat:"s" == selected_client_id|stringformat:"s" %}selected{% endif %}>
                                {{ client.full_name }} — {{ client.email }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="id_due_date">Due date (optional)</label>
                    <input type="date" id="id_due_date" name="due_date" value="{{ due_date_value }}" style="width:100%; padding:10px; border-radius:10px; border: 1px solid #d1d5db;" />
                </div>
                <div>
                    <label for="id_status">Status</label>
                    <select id="id_status" name="status" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db;">
                        {% for val,label in status_choices %}
                            <option value="{{ val }}" {% if val == status_value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </fieldset>

        <fieldset class="module aligned panel">
            <h2>Visa Applications <span class="pill">Step 2</span></h2>
            <p class="meta-text" style="margin: 0 0 10px 0;">Select applications from the dropdown, add them one by one, and set per-item discounts.</p>
            <input type="hidden" id="items-json" name="items_json" value="{{ items_payload|default:"" }}">

            <div class="item-adder" style="border: 1px dashed #cbd5e1; padding: 14px; border-radius: 12px; background: #f8fafc; margin-bottom: 12px;">
                <div class="item-adder-row">
                    <div>
                        <label class="required" for="application-select">Visa application</label>
                        <select id="application-select" style="width: 100%; min-width: 240px; padding: 10px; border-radius: 10px; border: 1px solid #d1d5db;">
                            <option value="">-- Select a client first --</option>
                        </select>
                    </div>
                    <div>
                        <label for="item-discount">Item discount</label>
                        <input type="number" step="0.01" min="0" id="item-discount" value="0" style="width: 100%; padding:10px; border-radius:10px; border: 1px solid #d1d5db;" />
                    </div>
                    <div>
                        <span class="adder-label">Action</span>
                        <button type="button" id="add-item-btn" class="primary-btn adder-button" disabled>+ Add item</button>
                    </div>
                </div>
                <div id="applications-empty" class="meta-text" style="margin-top: 6px;">Select a client to load their visa applications.</div>
            </div>

            <div id="items-list" class="items-card">
                <div id="items-empty" class="meta-text">No items added yet.</div>
            </div>
        </fieldset>

        <fieldset class="module aligned panel">
            <h2>Totals <span class="pill">Step 3</span></h2>
            <div class="field-grid" style="margin-bottom: 12px;">
                <div>
                    <label for="id_tax_rate">Tax rate (%)</label>
                    <input type="number" step="0.01" min="0" id="id_tax_rate" name="tax_rate" value="{{ tax_rate_value|default:'0' }}" style="width:100%; padding:10px; border-radius:10px; border: 1px solid #d1d5db;" />
                </div>
            </div>
            <div class="totals-block">
                <div class="totals-row">
                    <span>Items total</span>
                    <strong id="items-total">0.00</strong>
                </div>
                <div class="totals-row">
                    <span>Discount total</span>
                    <span id="summary-discount">0.00</span>
                </div>
                <div class="totals-row">
                    <span>Tax</span>
                    <span id="summary-tax">0.00</span>
                </div>
                <div class="totals-row" style="font-size: 16px;">
                    <span>Total</span>
                    <strong id="summary-total">0.00</strong>
                </div>
            </div>
        </fieldset>

        <fieldset class="module aligned panel">
            <h2>Notes</h2>
            <div class="form-row">
                <textarea name="notes" id="id_notes" rows="4" style="width: 100%; padding:10px; border-radius:10px; border: 1px solid #d1d5db;">{{ notes_value }}</textarea>
            </div>
        </fieldset>

        <div id="submit-row" class="relative lg:sticky lg:bottom-0 z-40">
            <div class="backdrop-blur-xs bg-white/80 rounded-b-default pb-4 px-4 dark:bg-base-900/80 lg:border-t lg:border-base-200 relative lg:scrollable-top lg:py-0 dark:border-base-800">
                <div class="flex flex-col-reverse gap-3 items-center mx-auto lg:flex-row-reverse container lg:h-[64px]">
                    <button type="submit" form="invoice_form" name="_save" class="bg-primary-600 block border border-transparent cursor-pointer font-medium px-3 py-2 rounded-default text-white w-full lg:w-auto">
                        {% translate 'Save' %}
                    </button>
                    <div class="flex flex-col gap-3 mr-auto w-full lg:flex-row lg:w-auto">
                        <a href="{% url 'admin:core_invoice_changelist' %}" class="border border-base-200 cursor-pointer font-medium px-3 py-2 rounded-default text-center transition-all w-full hover:bg-base-50 lg:block lg:w-auto dark:border-base-700 dark:hover:text-base-200 dark:hover:bg-base-900">
                            {% translate 'Close' %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    (function() {
        const clientSelect = document.getElementById('client-select');
        const appsList = document.getElementById('applications-list');
        const appsEmpty = document.getElementById('applications-empty');
        const itemsList = document.getElementById('items-list');
        const itemsEmpty = document.getElementById('items-empty');
        const itemsTotalEl = document.getElementById('items-total');
        const discountEl = document.getElementById('summary-discount');
        const taxEl = document.getElementById('summary-tax');
        const totalEl = document.getElementById('summary-total');
        const taxRateInput = document.getElementById('id_tax_rate');
        const itemsJsonField = document.getElementById('items-json');
        const addBtn = document.getElementById('add-item-btn');
        const itemDiscountInput = document.getElementById('item-discount');

        let availableApps = [];
        let items = [];
        const preselectedRaw = {{ items_payload|default:'[]'|safe }};

        function currencySymbol(code) {
            if (code === 'GBP') return '£';
            if (code === 'USD') return '$';
            if (code === 'EUR') return '€';
            return code ? code + ' ' : '';
        }

        function recalcTotals() {
            let subtotal = 0;
            let currency = 'GBP';
            items.forEach(item => {
                subtotal += parseFloat(item.price || 0);
                if (item.currency) {
                    currency = item.currency;
                }
            });

            const discount = items.reduce((acc, item) => acc + (parseFloat(item.discount || 0) || 0), 0);
            const taxRate = parseFloat(taxRateInput.value || '0') || 0;

            const afterDiscount = Math.max(subtotal - discount, 0);
            const taxAmount = (afterDiscount * taxRate) / 100;
            const total = afterDiscount + taxAmount;

            const symbol = currencySymbol(currency);
            itemsTotalEl.textContent = symbol + subtotal.toFixed(2);
            discountEl.textContent = symbol + discount.toFixed(2);
            taxEl.textContent = symbol + taxAmount.toFixed(2);
            totalEl.textContent = symbol + total.toFixed(2);
        }

        function updateAppSelect() {
            const select = document.getElementById('application-select');
            const selectedIds = new Set(items.map(i => String(i.id)));
            select.innerHTML = '';

            if (!availableApps || availableApps.length === 0) {
                select.innerHTML = '<option value="">No visa applications found for this client</option>';
                select.disabled = true;
                addBtn.disabled = true;
                return;
            }

            let options = '<option value="">-- Select an application --</option>';
            availableApps.forEach(app => {
                if (selectedIds.has(String(app.id))) {
                    return;
                }
                const display = app.name || app.display || ('Application #' + app.id);
                const price = parseFloat(app.price || 0);
                const symbol = currencySymbol(app.currency || 'GBP');
                options += `<option value="${app.id}" data-price="${price}" data-currency="${app.currency || 'GBP'}" data-name="${display}">${display} — ${symbol}${price.toFixed(2)}</option>`;
            });
            select.innerHTML = options;
            select.disabled = false;
            addBtn.disabled = false;
        }

        function renderItems() {
            itemsList.innerHTML = '';
            if (!items.length) {
                itemsEmpty.style.display = 'block';
                itemsList.appendChild(itemsEmpty);
                recalcTotals();
                itemsJsonField.value = '';
                return;
            }
            itemsEmpty.style.display = 'none';

            items.forEach((item, idx) => {
                const row = document.createElement('div');
                row.className = 'item-row';

                const title = document.createElement('div');
                const priceVal = parseFloat(item.price || 0);
                title.innerHTML = `<h4>${item.name}</h4><div class="subline">${currencySymbol(item.currency)}${priceVal.toFixed(2)}</div>`;

                const discountWrap = document.createElement('div');
                discountWrap.innerHTML = '<label style="margin:0; color:#374151; font-weight:600;">Discount</label>';
                const discountInput = document.createElement('input');
                discountInput.type = 'number';
                discountInput.step = '0.01';
                discountInput.min = '0';
                discountInput.value = item.discount || 0;
                discountInput.style.width = '100%';
                discountInput.style.padding = '8px';
                discountInput.style.borderRadius = '8px';
                discountInput.style.border = '1px solid #d1d5db';
                discountInput.addEventListener('input', () => {
                    let val = parseFloat(discountInput.value || 0);
                    if (isNaN(val) || val < 0) val = 0;
                    const price = parseFloat(item.price || 0);
                    if (val > price) val = price;
                    discountInput.value = val.toFixed(2);
                    items[idx].discount = val;
                    recalcTotals();
                });
                discountWrap.appendChild(discountInput);

                const actionWrap = document.createElement('div');
                const actionLabel = document.createElement('span');
                actionLabel.className = 'item-action-label';
                actionLabel.textContent = 'Action';
                actionWrap.appendChild(actionLabel);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'button';
                removeBtn.textContent = 'Remove';
                removeBtn.style.cursor = 'pointer';
                removeBtn.style.background = '#fee2e2';
                removeBtn.style.color = '#b91c1c';
                removeBtn.style.border = '1px solid #fecaca';
                removeBtn.style.borderRadius = '10px';
                removeBtn.style.padding = '8px 10px';
                removeBtn.addEventListener('click', () => {
                    items.splice(idx, 1);
                    updateAppSelect();
                    renderItems();
                });
                actionWrap.appendChild(removeBtn);

                row.appendChild(title);
                row.appendChild(discountWrap);
                row.appendChild(actionWrap);
                itemsList.appendChild(row);
            });

            itemsJsonField.value = JSON.stringify(items);
            recalcTotals();
        }

        function loadApplications(clientId) {
            if (!clientId) {
                availableApps = [];
                updateAppSelect();
                items = [];
                renderItems();
                appsEmpty.textContent = 'Select a client to load their visa applications.';
                recalcTotals();
                return;
            }

            appsEmpty.style.display = 'block';
            appsEmpty.textContent = 'Loading applications...';

            const url = new URL("{% url 'admin:core_invoice_get_available_applications' %}", window.location.origin);
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('invoice_id', '0');

            fetch(url.toString())
                .then(resp => resp.json())
                .then(data => {
                    if (data.error) {
                        appsEmpty.textContent = data.error;
                        availableApps = [];
                        updateAppSelect();
                        return;
                    }
                    availableApps = (data.available_applications || []).map(app => ({
                        id: app.id,
                        name: app.name || app.display || app.text,
                        price: parseFloat(app.price || 0),
                        currency: app.currency || 'GBP'
                    }));
                    updateAppSelect();
                    renderItems();
                })
                .catch(() => {
                    appsEmpty.textContent = 'Failed to load applications. Please try again.';
                    availableApps = [];
                    updateAppSelect();
                });
        }

        clientSelect.addEventListener('change', function() {
            items = [];
            itemsJsonField.value = '';
            loadApplications(this.value);
        });

        taxRateInput.addEventListener('input', recalcTotals);

        addBtn.addEventListener('click', () => {
            const select = document.getElementById('application-select');
            const appId = select.value;
            if (!appId) return;
            const selected = availableApps.find(a => String(a.id) === String(appId));
            if (!selected) return;

            let discountVal = parseFloat(itemDiscountInput.value || 0);
            if (isNaN(discountVal) || discountVal < 0) discountVal = 0;
            const priceVal = parseFloat(selected.price || 0);
            if (discountVal > priceVal) discountVal = priceVal;

            items.push({
                id: selected.id,
                name: selected.name || selected.display || selected.text || ('Application #' + selected.id),
                price: priceVal,
                currency: selected.currency || 'GBP',
                discount: discountVal
            });

            itemDiscountInput.value = '0';
            updateAppSelect();
            renderItems();
        });

        // Initial load if a client was preselected
        if (clientSelect.value) {
            try {
                if (preselectedRaw && typeof preselectedRaw === 'string') {
                    items = JSON.parse(preselectedRaw) || [];
                } else if (Array.isArray(preselectedRaw)) {
                    items = preselectedRaw;
                }
            } catch (e) {
                items = [];
            }
            renderItems();
            loadApplications(clientSelect.value);
        }
    })();
</script>
{% endblock %}
